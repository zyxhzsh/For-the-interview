### 索引

**索引**：将数据表中的某个或某些字段与记录的位置建立一个对应的关系，并按照一定的顺序排序好。目的是快速定位指定数据的位置。

添加索引是给某一个字段，或者说某些字段添加索引。没有索引时sql语句会进行全表扫描。

在数据库方面，查询一张表的时候有两种检索方式：全表扫描、根据索引检索(效率很高)。
索引为什么可以提高检索效率呢？因为缩小了扫描的范围。

索引和约束的区别在于：约束用于维护数据库完整性的规则，而索引是为了方便对数据进行检索。

[索引的分类](#索引的分类)

[索引的实现原理](#索引的实现原理)

[创建索引](#创建索引)

[最左前缀原则](#最左前缀原则)

[前缀索引如何选择字段长度](#前缀索引如何选择字段长度)

[查看与分析索引](#查看与分析索引)

[删除索引](#删除索引)

[索引的使用原则](#索引的使用原则)

[使用索引的注意事项](#使用索引的注意事项)

### 索引的分类

**普通索引**：由INDEX定义，没有限制条件。

**唯一索引**：由UNIQUE INDEX定义，索引的字段需要添加UNIQUE约束，用于防止用户添加重复的值。若创建唯一索引的字段值重复，会创建失败。

**主键索引**：由PRIMARY KEY定义的一种特殊的唯一性索引，不允许null值。 根据主键查询效率较高，尽量根据主键检索。

若在InnoDB表中数据保存的顺序与主键索引字段的顺序一致时，可将这种主键索引称为“聚簇索引”。一般聚簇索引都是主键，因此一张数据表中只能有一个聚簇索引。

**全文索引**：由FULLTEXT INDEX定义，用于根据查询字符提高数据量较大的字段查询速度。此索引在定义时字段类型必须是CHAR、VARCHAR 或TEXT中的一种。MyISAM和InnoDB支持全文索引。

根据创建索引的字段个数可以将索引分为单列索引和复合索引。

对于**复合索引**，只有在查询条件中使用了这些字段中的第一个字段时，该索引才会被使用。因为复合索引默认使用第一个字段的名称作为索引名。

**前缀索引**：若创建的索引是从左开始截取数据表中字段值的一部分内容，这种索引可以统称为前缀索引。根据搜因开始的部分字符，可以大大节约索引空间。

### 索引的实现原理

索引底层采用的数据结构是：B + Tree。

通过B Tree缩小扫描范围，底层索引进行了排序，分区，索引会携带数据在表中的"物理地址"，最终通过索引检索到数据之后，获取到关联的物理地址。通过物理地址定位表中的数据，效率是最高的。

		select ename from emp where ename = 'SMITH';

通过索引转换为：

		select ename from emp where  物理地址 = 0x123;

### 创建索引

可以在创建数据表时创建索引，也可以对已创建的数据表修改索引或创建索引。向已创建的数据表添加索引时，不能添加主键索引，只能修改主键索引。可以通过ALTER TABLE修改主键索引。

创建索引

```
create [...] index 索引名称 on 表名(字段列表); #向已创建的数据表添加索引

alter table 表名 #向已创建的数据表添加索引。这种方式可以创建也可以修改索引。
	ADD PRIMARY KEY (字段列表) #修改主键索引
	| ADD [...] index 索引名称(字段列表); #修改其他索引

CREATE TABLE 表名(
	字段名 数据类型[长度] [约束条件]
	...
	[...] index 索引名称(字段列表);
);

全文索引使用特定语法
MATCH(字段列表) AGAINST(字符串)
字符串就是要查找的内容，该内容必须是字段值中一个完整的单词或句子，不能是单词中的一部分，否则查不到。这是和模糊查询不同的。
```

删除索引

```
drop index 索引名称 on 表名;
```

### 最左前缀原则

复合索引，多个字段的设置顺序要遵循最左前缀原则：把最频繁使用的字段放在最左侧，然后以此类推。只有第在查询时，只有第一个字段被使用时，该复合索引才会被使用。

### 前缀索引如何选择字段长度

实际中有时需要设置索引的字段值是一个很长的字符，这会导致索引变大且检索速度也变慢。使用前缀索引的方式，在保证较高查询效率的同时避免空间的浪费。前缀索引，字段长度的设定要通过计算和测试才能选取最合适的一个范围。如使用“不重复的索引数量/总记录数”这个方法，对比查询时不设长度与设长度时最接近的值，第二考虑的是尽可能选长度小的（两种长度都与不设长度的值很接近，可以选长度短的）。然后用这个值作为前缀索引的字段长度。

### 查看与分析索引

```
SHOW INDEX FROM 表名 \G; #查询表中的所有索引信息。\G是为了排版更好看

EXPLAIN SQL语句; #分析SQL语句的执行情况。
```

索引覆盖：查询的字段恰好是索引的一部分或者与索引完全一致，那么查询只需要在索引区上进行，不需要到数据区检索数据。这种查询速度非常快，但会增加索引文件的大小。只有此索引的使用率尽可能高时，索引覆盖才有意义。否则应尽量避免。

### 删除索引

（1）删除非主键索引

```
两种语法均可
alter table 表名 drop index 索引名;

drop index 索引名 on 表名;
```

（2）删除主键索引

若主键字段含有AUTO_INCREMENT，则在删除主键索引前必须先删除该属性，否则会报错。

```
删除主键字段的AUTO_INCREMENT属性
alter table 表名 modify 字段名 字段类型

删除主键索引，两种语法均可
alter table 表名 drop primary key;

drop index `PRIMARY` on 表名;
```

### 索引的使用原则

索引虽然可以提高检索效率，但是不能随意的添加索引。因为索引也是数据库当中的对象，也会占用物理空间，也需要数据库不断的维护。创建和维护索引，消耗的时间会随着数据量的增长而增长。

1.查询条件中频繁使用的字段适合建立索引。

2.更新频繁的字段不适合建立索引。因为数据一旦修改，索引需要重新排序。

3.重复值较高的字段不适合建立索引。

4.存储空间较小的字段适合建立索引。

5.数字型的字段适合建立索引。

6.数据量庞大时需要添加索引(根据客户的需求，根据线上的环境)。

### 使用索引的注意事项

MySQL的优化器在查询时会判断全表扫描是否会比使用索引慢，哪个快就会使用哪个。

（1）查询时保证字段的独立。

对于建立索引的字段，在查询时要保证该字段在关系运算符的一侧独立，“独立”是指索引字段不能是表达式的一部分或函数的参数。

如id+2>3，id在>的左侧不独立，所以查询时不会使用索引。id>3-2,id在>的左侧独立，查询时会使用索引。可以使用EXPLAIN语句进行分析。

（2）模糊查询时，若第一个通配符使用的是%，这时索引是失效的。会采用全表扫描的方式查询。

（3）分组查询时排序的设置。

分组查询时默认对分组的字段进行排序，若想避免分组后的排序对性能的消耗，可以在分组后使用ORDER BY NULL禁止排序。


